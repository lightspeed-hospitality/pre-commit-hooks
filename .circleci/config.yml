---
version: 2.1
orbs:
  lsk-python: lsk/python@2.0
  gh: circleci/github-cli@2.7.2

jobs:
  create-prs:
    executor: python/python-3-13
    steps:
      - checkout
      - gh/install
      - gh/setup
      - lsk-python/install-uv
      - lsk-python/get-codeartifact-token
      - lsk-python/add-codeartifact-uv
      - run:
          name: Create uv config file
          command: |
            mkdir -p ~/.config/uv
            echo '[[index]]' > ~/.config/uv/config.toml
            echo 'name = "lsk-pypi"' >> ~/.config/uv/config.toml
            echo 'url = "https://lsk-809245501444.d.codeartifact.us-east-1.amazonaws.com/pypi/lsk-pypi/simple/"' >> ~/.config/uv/config.toml
            echo 'default = true' >> ~/.config/uv/config.toml
      - run:
          name: Install repo-tools
          command: |
            sudo uv pip install --system --config-file ~/.config/uv/config.toml repo-tools
      - run:
          name: Get latest release
          command: |
            gh release view --json tagName --jq .tagName > LATEST_RELEASE
      - run:
          name: Create PR for new release
          command: |
            export BRANCH_NAME="bump-pre-commit-hooks-to-$(cat LATEST_RELEASE)"
            rt gh multi-edit \
            --branch "$BRANCH_NAME" \
            --commit-message "NOJIRA Bump pre-commit hooks" \
            --org "lightspeed-hospitality" \
            --pr-description "A new version of pre-commit hooks is available." \
            --apply-labels "⚠️ E2E Not Required" \
            --file-path ".pre-commit-config.yaml" \
            --auto-replace-with "$(cat LATEST_RELEASE)" \
            --regex "(?<=^(\s*-\s*repo:\s*https://github\.com/lightspeed-hospitality/pre-commit-hooks\.git\n\s*rev:\s*))[^\n\s]+" \
            --run-commands "pre-commit install" \
            --run-commands "pre-commit run" \
            --keep_repos false \
            --yes \
            "repo: https://github.com/lightspeed-hospitality/pre-commit-hooks.git"

workflows:
  main:
    jobs:
      - lsk-python/pre-commit:
          context: global
          executor-name: "python-3-9"
  auto-pr:
    triggers:
      - schedule:
          cron: "0 12 * * *" # every day at noon
          filters:
            branches:
              only:
                - main
    jobs:
      - create-prs:
          context: global
          filters:
            branches:
              only:
                - main
